---
name: Build and test

on:
  push:
    branches:
      - main
      - master
    tags:
      - '**'
  pull_request:
    branches:
      - main
      - master
  schedule:
    - cron: '0 1 * * *'

concurrency:
  group: ${{ github.workflow }}@${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  package_name: random-pure
  PACK_DIR: /root/.pack

jobs:

  build-and-test:
    name: Build and test `${{ env.package_name }}`
    runs-on: ubuntu-latest
    container: ghcr.io/stefan-hoeck/idris2-pack:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Switch to a specific `pack` collection
        if: github.event_name != 'schedule'
        run: pack switch "$(cat .pack-collection)"
      - name: Switch to the latest `pack` collection
        if: github.event_name == 'schedule'
        run: pack switch latest
      - name: Build `${{ env.package_name }}`
        run: pack build ${{ env.package_name }}
      - name: Test `${{ env.package_name }}`
        run: pack test ${{ env.package_name }}
